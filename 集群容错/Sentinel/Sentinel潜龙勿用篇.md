### 前言
我为什么写这篇文章，是因为Sentinel实在是太强大太好用了，再加上阿里开源，Sentinel的发展迅猛。已有多家公司生产使用，但但凡神功，一个不慎，就有可能走火入魔，轻则离职走人，重则走火入魔踏上跑路生涯。本文本着你对官方秘籍已经通篇阅读无一不懂的前提，来此避坑，如无上述经历，请即刻返程回读。

#### 限流篇
为什么要使用Sentinel？

我们为什么要搞限流，限流的作用是什么在此不做赘述，但是在做限流前我们需要思考一个问题，为什么要用Sentinel，达到什么样的流量需要采用限流，什么样的应用适合Sentinel。

新的中间件的应用，尤其是这种作用在应用层的我们一定要考虑的一个问题就是能效的提升会是多少，这种提升的正面例子就是你的应用的稳定性，负面例子自然是所带来的额外开销，响应时间，维护成本等。

很欣慰的是Sentinel本身的设计还是很OK的，性能上的影响微乎其微，具体请参加官方wiki。

Sentinel的很多设计很多算法都是源于Guava，感兴趣的同学可以试着去了解一下。

令牌桶，漏桶算法，是限流界的经典理论支柱，无论是Hystrix还是Sentinel都是在其基础上做的变化，所谓一法通，万法通，便是其理。

一般来讲，当你的应用没有复杂到一定程度的时候，我并不建议你入坑，假如你只是想吃米饭，但是来了一大堆食物，于你而言就是食之无味，弃之可惜。（此处对于其他中间价一样适用）如果限流是必要的，但是应用并没有庞大到一定地步，那么我建议你单独使用限流，利用已有的比如RateLimit来实现你的限流。一般来讲，底层应用只需要限流就OK了，如果说你的应用限流这快业务需求需要更灵活的，比如预热，或者基于调用关系等更复杂更多样的，那么没错，sentinel就是你的最佳选择。

#### 降级熔断篇

降级熔断也是Sentinel的一个很优秀的功能，用处不做赘述。

熔断这块Sentinel提供了三种方式，平均响应时间，平均失败率，异常数目。统计方式这块是用滑动窗口来设计的。达到熔断条件，Sleep。目前最新的版本支持自定义统计窗口。
此处的话时间窗口会有个默认值，5，即单位窗口内，达到熔断条件的时候并不会立即熔断，而是处于熔断就绪的状态，具体熔断与否取决于这五个请求，详细自行观看源码。

再次说个题外话，我们需要明白一点，一旦采用平均值或者什么率这块我们就需要明白一点，容易发生木桶效应。假设我们采用了平均响应时间，你前一百次的平均值都为100，但是后面系统出现问题，相应时间这块为100000，但是sentinel这块的话记作5000（注：基于RT的话当系统相应时间超过5000时会直接认为超时记录为5000），平均值下来亦然达不到熔断条件。也就是说当你的系统已经处于不正常的状态的时候并不能第一时间进行降级。

基于异常比例亦然，只是说当你的流量数过多的时候才会呈现出较好的表现。假设你前6个流量都是异常（可能是预热或其他并非不正常的行为导致的异常），那么系统会直接进入降级。过早地夭折。

平均值受最大值影响，比率受初始分子分母的影响。
基于此 ，希望各位选用自己合适的方式来讲行熔断选择。
#### 尾篇 熔断  
 熔断这块没有一个熔断半开的状态，有时候我们的系统确实被搞垮了，熔断时间过后，仍然没有恢复正常，这个时候我们最好的做法是放一个流量过去，而不是大多数流量，这个流量的成功与否决定着我们的系统是否恢复到熔断关闭的状态。
 
 限流熔断可以考虑是否引入其他因素来进行衡量，比如系统的负载等等。另外一点，当达到熔断的时候我们是应该直接熔断还是说进行一个流量的限制，是进行平缓的降级还是说粗暴的降级。
 
 目前Sentinel尚有许多需要修改更正的，大家可以踊跃参与。









