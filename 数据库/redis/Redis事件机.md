redis 服务器是一个事件驱动程序，服务器需要处理以下两类事件：
- 文件事件（file event）：redis 服务器通过套接字与客户端进行连接，而文件事件就是服务器对套接字操作的抽象
- 时间事件（time event）：redis 服务器中的一些操作（比如 serverCron 函数）需要在给定的时间点执行，而时间事件就是服务器对这类定时操作的抽象

### 一、文件事件

**1.1 文件事件概述**

文件事件处理器使用 I/O 多路复用（multiplexing）程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器。

当被监听的套接字准备好执行连接应答（accept）、读取（read）、写入（write）、关闭（close）等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。

**1.2 文件事件组成结构**

![](http://redisbook.com/_images/graphviz-f0d024ca2782cbbe20e2cd1e52540d92f64b3a37.png)

文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答（accept）、写入、读取、关闭等操作时， 就会产生一个文件事件。因为一个服务器通常会连接多个套接字，所以多个文件事件有可能会并发地出现。

I/O 多路复用程序会将所有产生事件的套接字都入队到一个队列里面，然后通过这个队列，以有序（sequentially）、同步（synchronously）、每次一个套接字的方式向文件事件分派器传送套接字：当上一个套接字产生的事件被处理完毕之后，I/O 多路复用程序才会继续向文件事件分派器传送下一个套接字。

**1.3 文件事件处理器**

redis 为文件事件编写了多个处理器， 这些事件处理器分别用于实现不同的网络通讯需求

- 连接应答处理器：对连接服务器的各个客户端进行应答
- 请求处理器：接收客户端传来的命令请求
- 命令回复处理器：向客户端返回命令的执行结果
- ...

下面是一次客户端与服务器进行进行连接并发送命令的整个过程。

![](http://redisbook.com/_images/graphviz-ecd9b3ff243e2f34204c0f9f2a590058bf262d84.png)

**1.4 I/O 多路复用**

redis 的 I/O 多路复用程序的所有功能都是通过包装常见的 select 、 epoll 、 evport 和 kqueue 这些 I/O 多路复用函数库来实现的。
 
- select：目前几乎在所有的平台上支持，select 最大的缺陷就是单个进程所打开的 FD 有一定限制，对socket进行扫描时是线性扫描，即采用轮询的方法，效率较低
- poll：poll 本质上和 select 没有区别，它将用户传入的数组拷贝到内核空间，它没有最大连接数的限制，原因是它是基于链表来存储的，缺点是大量的 fd 的数组被整体复制于用户态和内核地址空间之间
- epoll：相对于 select 和 poll 来说，epoll 更加灵活，没有描述符限制，基于内存拷贝，利用 mmap()文件映射内存加速与内核空间的消息传递，只有活跃可用的 FD才 会调用 callback 函数；即 Epoll 最大的优点就在于它只管你“活跃”的连接，而跟连接总数无关

### 二、时间事件

**2.1 时间事件概述**

redis 的时间事件分为两类，一类是定时事件，在某个时刻执行；另一类是周期性事件，每隔一段时间执行一次。

 一个时间事件是定时还是周期性，取决于其返回值：如果返回的是 AE_NOMORE，表示其是一次性的事件，即定时的，执行完毕后 redis 会将其删除；如果返回的不是该结果，则表示是周期性事件，服务器会根据返回值，更新 unix 毫秒级时间戳，这样当下一次时间到达时又会执行该事件。

**2.2 实现方式**

 redis将所有的时间事件放在一个无序链表中，当时间事件执行器执行时，会遍历整个链表，将所有已到达执行时间的事件调用相应的时间事件处理器进行处理。

 主要流程如下：

 - 遍历服务器中所有的时间事件
 - 检查每个事件是否到达执行时间，对于已经到达的，执行事件，并获取返回值
 - 果返回的是 AE_NOMORE，表示是定时事件，则服务器删除该事件；否则表示其是周期性事件，服务器会更新事件的 when 属性，标记下一次执行时间

**2.3 serverCron函数**

当前 redis 只有周期性事件，且周期性事件中只有一个事件——serverCron 函数，该函数默认每秒执行 10 次，可以通过配置文件修改每秒执行次数。

redis 服务器开启后，就会周期性执行此函数，直到 redis 服务器关闭为止。

serverCron 函数主要进行以下操作：

- 清理数据库中的过期键值对
- 关闭和清理连接失败的客户端
- 尝试进行 aof 和 rdb 持久化操作
- 如果是主服务器，会定期将数据向从服务器做同步操作
- 如果处于集群模式，对集群定期进行同步与连接测试操作
- ...

### 三、相关知识总结

- 文件事件处理器是基于 Reactor 模式实现的网络通讯程序
- 时间事件分为定时事件和周期性事件： 定时事件只在指定的时间达到一次， 而周期性事件则每隔一段时间到达一次
- 服务器在一般情况下只执行 serverCron 函数一个时间事件， 并且这个事件是周期性事件
- 文件事件和时间事件之间是合作关系， 服务器会轮流处理这两种事件， 并且处理事件的过程中也不会进行抢占
- 由于通常先处理文件事件，因此时间事件的实际执行时间有可能比预设时间稍晚

### 参考资料

《Redis 设计与实现》 黄健宏 著 <br>
[https://www.jianshu.com/p/dfd940e7fca2](https://www.jianshu.com/p/dfd940e7fca2)